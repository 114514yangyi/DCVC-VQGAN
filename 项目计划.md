# DCVC + VQGAN/RVQ 视频压缩实验计划

## 项目概述

本项目旨在将 VQGAN 和残差向量量化（RVQ）技术集成到 DCVC 视频压缩框架中，替代传统的 CompressAI I-frame 模型，以提升视频压缩的率失真（Rate-Distortion）性能。

---

## 实验日志

### 已完成工作

#### 1. 数据集转换与代码清理 ✅
- **数据集转换**：已将原有的照片数据集（Vimeo-90k、HEVC-B、BVI-AOM 等）替换为视频数据集（MP4 文件），完全适配视频编码任务。
- **代码精简**：
  - 移除了 `VimeoGOPDataset`、`BVI_AOM_Dataset`、`HEVCB_Dataset` 等图像数据集类
  - 移除了 Stage 5（BVI-AOM finetuning）相关代码
  - 简化了评估逻辑，统一使用 `VideoValidationDataset`
  - 代码现在仅支持视频数据集（`VideoGOPDataset` 和 `VideoValidationDataset`）
- **代码注释**：为 `train_dcvc.py` 添加了详细的中文注释，便于理解和维护。

---

## 下一步工作安排

### 阶段 1：模型替换与评估基准建立

#### 1.1 替换 I-frame 模型
**目标**：将 CompressAI 的 I-frame 模型替换为 VQGAN 模型

**任务清单**：
- [ ] 集成 VQGAN 模型到 DCVC 训练框架
  - 修改 `compress_i_frame_with_padding()` 函数，支持 VQGAN 模型
  - 确保 VQGAN 输出格式与 DCVC 兼容
  - 处理 VQGAN 的编码/解码流程
- [ ] 验证 VQGAN 在 DCVC 框架内的正常运行
  - 测试单帧压缩/解压流程
  - 验证输出张量形状和数值范围
  - 检查内存占用和计算效率

**技术细节**：
- VQGAN 模型输入：RGB 图像 [B, 3, H, W]，值域 [0, 1]
- VQGAN 模型输出：重建图像 [B, 3, H, W]，值域 [0, 1]
- 需要计算 VQGAN 的 BPP（比特率）：基于量化码本的索引和概率分布

#### 1.2 基线实验
**目标**：建立多个 baseline 方法的性能基准

**测试方法**：
1. **H.265/HEVC**（传统编码器）
2. **DVC**（Deep Video Compression）
3. **VQGAN + Transformer**（仅使用 VQGAN 进行帧内编码）
4. **DCVC + CompressAI I-frame**（原始 DCVC，作为对比基准）

**评估指标**：
- **PSNR**（Peak Signal-to-Noise Ratio）：峰值信噪比，单位 dB
- **SSIM**（Structural Similarity Index）：结构相似性指数
- **LPIPS**（Learned Perceptual Image Patch Similarity）：感知相似性
- **FID**（Fréchet Inception Distance）：生成质量评估
- **BPP**（Bits Per Pixel）：每像素比特数，码率指标

**实验设计**：
- 使用相同的测试视频序列
- 对于每种方法，测试多个码率点（通过调整质量参数或 λ 值）
- 记录每个码率点对应的 PSNR、SSIM、LPIPS、FID、BPP

**可视化输出**：
- 绘制 **RD 曲线**（Rate-Distortion Curve）：
  - X 轴：BPP（码率）
  - Y 轴：PSNR/SSIM/LPIPS/FID（质量指标）
- 每个方法一条曲线，便于对比

**预期时间**：1-2 周

---

### 阶段 2：VQGAN + RVQ 改进实验

#### 2.1 模型架构设计
**目标**：基于 VQGAN 引入残差向量量化（RVQ）

**架构选择**：
- **基础 VQGAN**：16×16 分辨率（相比 32×32，更细粒度）
- **RVQ 层数**：8 层残差量化

**RVQ 原理**：
- 第一层量化原始特征
- 后续层量化前一层量化后的残差
- 通过控制使用的层数，实现 bitrate-scalable 的量化

#### 2.2 实验设计

**实验 1：RVQ 层数对比**
- **变量**：RVQ 层数（2、4、6、8 层）
- **固定条件**：
  - VQGAN 分辨率：16×16
  - 测试视频序列相同
  - 评估指标：PSNR、FID、LPIPS、SSIM、BPP
- **观察指标**：
  - 不同层数下的码率（BPP）变化
  - 不同层数下的质量（PSNR/FID）变化
  - 码率-质量权衡曲线

**实验 2：Bitrate-Scalable 量化验证**
- **目标**：验证通过调整 RVQ 层数可以实现码率控制
- **方法**：
  - 使用 2 层 RVQ：最低码率
  - 使用 4 层 RVQ：中等码率
  - 使用 6 层 RVQ：较高码率
  - 使用 8 层 RVQ：最高码率
- **分析**：
  - 绘制不同层数下的 RD 曲线
  - 评估码率伸缩的平滑性

**训练策略**（待确认）：
- **选项 A**：分层渐进训练（Progressive Learning）
  - 先训练 2 层，固定后训练 4 层，依此类推
- **选项 B**：端到端联合训练
  - 同时训练所有 8 层，通过损失函数控制不同层的重要性
- **选项 C**：混合策略
  - 先渐进训练，再端到端微调

**预期时间**：2-3 周

---

### 阶段 3：DCVC + VQGAN（Baseline）训练与测试

#### 3.1 架构设计
**目标**：将 VQGAN 集成到 DCVC 框架作为 I-frame 编码器

**架构**：
- **I-frame 编码**：VQGAN（32×32 分辨率，作为 baseline）
- **P-frame 编码**：DCVC（保持原有架构）

#### 3.2 训练策略

**训练阶段**：遵循 DCVC 的 4-stage 训练流程
- **Stage 1**：预热运动估计和运动编码模块
- **Stage 2**：冻结运动模块，训练残差编码模块
- **Stage 3**：继续训练残差编码，加入比特率损失
- **Stage 4**：端到端联合优化所有模块

**码率控制**：通过调整 λ 值控制码率-失真权衡
- **λ = 256**：低码率（高压缩比）
- **λ = 512**：中低码率
- **λ = 1024**：中高码率
- **λ = 2048**：高码率（高质量）

**训练参数**：
- GOP 大小：7（训练时），32（评估时）
- 批次大小：4-8（根据 GPU 内存调整）
- 学习率：1e-4（初始），使用调度器调整
- 训练数据：视频数据集（MP4 文件）

#### 3.3 测试与评估

**测试指标**：
- PSNR、SSIM、LPIPS、FID、BPP

**对比实验**：
- vs **DCVC + CompressAI I-frame**（原始方法）
- vs **H.265/HEVC**
- vs **DVC**

**输出**：
- 每个 λ 值对应的 RD 性能点
- 绘制 RD 曲线
- 分析不同 λ 对压缩性能的影响

**预期时间**：3-4 周

---

### 阶段 4：DCVC + RVQ-VQGAN（改进版本）训练与测试

#### 4.1 架构设计
**目标**：将 RVQ-VQGAN 集成到 DCVC 框架

**架构**：
- **I-frame 编码**：VQGAN（16×16）+ 8-layer RVQ
- **P-frame 编码**：DCVC（保持原有架构）

#### 4.2 训练策略

**训练阶段**：同样采用 4-stage 训练流程

**码率控制**：
- **方法 1**：通过调整 λ 值（256/512/1024/2048）
- **方法 2**：通过调整 RVQ 层数（2/4/6/8 层）+ 固定 λ
- **方法 3**：组合调整（λ + RVQ 层数）

**训练参数**：与阶段 3 相同

#### 4.3 测试与对比

**对比实验组**：
1. **DCVC + Baseline VQGAN (32×32)**
2. **DCVC + Baseline VQGAN (16×16)**
3. **DCVC + RVQ-VQGAN (16×16, 8-layer)**
4. **DCVC + CompressAI I-frame**（原始方法）

**评估维度**：
- **码率范围**：测试从低码率到高码率的完整范围
- **质量指标**：PSNR、SSIM、LPIPS、FID
- **计算效率**：编码/解码时间、内存占用

**分析重点**：
- RVQ-VQGAN 是否优于传统 VQGAN？
- 16×16 VQGAN 是否优于 32×32 VQGAN？
- RVQ 的 bitrate-scalable 特性是否带来优势？

**预期时间**：3-4 周

---

## 预期结果与贡献

### 1. RVQ-VQGAN 的有效性验证
- **预期**：残差量化能提供更好的比特率伸缩性（不同层数对应不同 bpp）
- **贡献**：验证 RVQ 在视频压缩中的有效性，提供 bitrate-scalable 的量化方案

### 2. DCVC-VQGAN/RVQ 的结合效果
- **预期**：通过 VQGAN/RVQ 替代传统 I-frame 模型可以提升压缩效率
- **贡献**：证明深度生成模型（VQGAN）在视频压缩中的优势

### 3. 全面的性能对比
- **预期**：整理多个 baseline 和实验组的 RD 曲线
- **贡献**：明确 RVQ 在不同条件下的优劣，为后续研究提供参考

### 4. 技术贡献
- **架构创新**：将 VQGAN/RVQ 集成到 DCVC 框架
- **训练策略**：探索 RVQ 的分层训练与端到端训练策略
- **评估体系**：建立多指标（PSNR、SSIM、LPIPS、FID）的评估体系

---

## 待确认问题

### 1. VQGAN 输出特征适配问题
**问题**：VQGAN 输出的特征是否需要适应 DCVC 的训练？是否需要调整 loss？

**考虑因素**：
- VQGAN 的量化特征与 CompressAI 的潜在表示可能不同
- DCVC 的 P-frame 编码器可能需要适配 VQGAN 的特征空间
- Loss 函数是否需要加入 VQGAN 特定的正则化项

**建议方案**：
- **方案 A**：保持 DCVC 原有 loss（MSE + λ * BPP），仅替换 I-frame 模型
- **方案 B**：加入感知损失（LPIPS）或对抗损失，与 VQGAN 训练保持一致
- **方案 C**：设计联合 loss，平衡重建质量和码率

**需要实验验证**：对比不同 loss 组合的效果

---

### 2. RVQ 训练策略问题
**问题**：RVQ 训练是否采取分层训练（progressive learning），还是联合端到端训练？

**选项分析**：

**选项 A：分层渐进训练**
- **优点**：
  - 每层可以充分学习残差信息
  - 训练稳定，不易出现梯度消失
  - 可以逐步增加模型容量
- **缺点**：
  - 训练时间长（需要多次训练）
  - 可能陷入局部最优
  - 层间依赖关系可能不够紧密

**选项 B：端到端联合训练**
- **优点**：
  - 训练时间短（一次训练完成）
  - 层间可以学习最优的协作关系
  - 全局优化，可能找到更好的解
- **缺点**：
  - 训练难度大，需要精心设计 loss
  - 可能出现训练不稳定
  - 需要更多的超参数调优

**选项 C：混合策略**
- **步骤**：
  1. 先进行分层渐进训练（2→4→6→8 层）
  2. 固定前几层，端到端微调后几层
  3. 最后整体端到端微调
- **优点**：结合两种方法的优势
- **缺点**：训练流程复杂

**建议**：先尝试选项 B（端到端训练），如果效果不佳，再尝试选项 A 或 C

---

### 3. DCVC 四阶段训练与 RVQ 结合问题
**问题**：DCVC 的四阶段训练如何与 RVQ 的渐进量化结合？是否需要调整训练顺序？

**分析**：

**当前 DCVC 训练流程**：
- Stage 1：训练运动模块
- Stage 2-3：训练残差编码模块（运动模块冻结）
- Stage 4：端到端训练

**RVQ 的量化特性**：
- 不同层数对应不同码率
- 需要学习残差信息

**可能的结合方案**：

**方案 A：独立训练 RVQ，然后集成**
- 先单独训练 RVQ-VQGAN（8 层）
- 然后将其作为 I-frame 模型集成到 DCVC
- 按照 DCVC 的 4-stage 流程训练
- **优点**：简单直接，不影响 DCVC 训练流程
- **缺点**：可能没有充分利用 RVQ 的 bitrate-scalable 特性

**方案 B：在 DCVC Stage 4 中调整 RVQ 层数**
- Stage 1-3：使用固定 RVQ 层数（如 8 层）
- Stage 4：根据 λ 值动态调整 RVQ 层数
  - λ=256：使用 2-4 层（低码率）
  - λ=512：使用 4-6 层（中码率）
  - λ=1024：使用 6-8 层（高码率）
- **优点**：充分利用 RVQ 的码率控制能力
- **缺点**：需要修改训练流程，增加复杂度

**方案 C：多阶段 RVQ 训练**
- Stage 1：训练运动模块 + RVQ（2 层）
- Stage 2：训练残差编码 + RVQ（4 层）
- Stage 3：继续训练 + RVQ（6 层）
- Stage 4：端到端训练 + RVQ（8 层）
- **优点**：渐进式增加模型容量
- **缺点**：训练流程复杂，可能影响 DCVC 的训练效果

**建议**：先采用方案 A（独立训练后集成），验证基本可行性；如果效果良好，再尝试方案 B 进行优化

---

## 时间线规划

| 阶段 | 任务 | 预计时间 | 状态 |
|------|------|----------|------|
| 准备阶段 | 数据集转换与代码清理 | 1 周 | ✅ 已完成 |
| 阶段 1 | 模型替换与评估基准建立 | 1-2 周 | 🔄 进行中 |
| 阶段 2 | VQGAN + RVQ 改进实验 | 2-3 周 | ⏳ 待开始 |
| 阶段 3 | DCVC + VQGAN（Baseline）训练 | 3-4 周 | ⏳ 待开始 |
| 阶段 4 | DCVC + RVQ-VQGAN（改进版本）训练 | 3-4 周 | ⏳ 待开始 |
| 总结阶段 | 结果分析与论文撰写 | 2-3 周 | ⏳ 待开始 |

**总预计时间**：12-18 周（3-4.5 个月）

---

## 风险评估与应对

### 风险 1：VQGAN 与 DCVC 集成困难
- **风险**：VQGAN 的输出格式与 DCVC 不兼容
- **应对**：提前进行接口测试，必要时修改 VQGAN 的输出层或 DCVC 的输入层

### 风险 2：RVQ 训练不稳定
- **风险**：端到端训练 RVQ 可能出现梯度爆炸或消失
- **应对**：准备分层训练方案作为备选，使用梯度裁剪和适当的学习率

### 风险 3：计算资源不足
- **风险**：RVQ 和 DCVC 结合后模型较大，训练时间长
- **应对**：优化代码，使用混合精度训练，必要时减少 batch size 或 GOP size

### 风险 4：实验结果不理想
- **风险**：RVQ-VQGAN 可能不如预期效果好
- **应对**：即使效果不佳，也要分析原因，为后续研究提供经验

---

## 参考资料

1. DCVC 论文与代码
2. VQGAN 论文与实现
3. RVQ（Residual Vector Quantization）相关文献
4. CompressAI 文档
5. 视频压缩评估指标（PSNR、SSIM、LPIPS、FID）标准

---

## 更新日志

- **2024-XX-XX**：创建实验计划文档
- **2024-XX-XX**：完成数据集转换与代码清理
- **2024-XX-XX**：开始阶段 1 工作

---

**备注**：本文档将根据实验进展持续更新，记录实际遇到的问题和解决方案。
